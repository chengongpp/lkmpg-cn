# 引言

## 1.3 内核模块是什么


## 1.4 内核模块软件包

Linux发行版提供了包括`modprobe`、`insmod`和`depmod`等命令的软件包。命令参考如下。

在Ubuntu和Debian上，执行

```shell
sudo apt-get install build-essential kmod
```

在Arch Linux上，执行

```shell
sudo pacman -S gcc kmod
```

## 1.5 我的内核里有哪些模块？

要查看你的内核里已经加载的模块，可以使用`lsmod`命令。

```shell
sudo lsmod
```

内核模块记录在`/proc/modules`文件中，所以你也可以这样查看内核模块：

```shell
sudo cat /proc/modules
```

输出内容可能很长，有时你只想从中找到一个特定模块。比如如果你想找`fat`模块，可以这样：

```shell
sudo lsmod | grep fat
```

## 1.6 我需要下载内核源码重新编译一遍内核吗？

如果只是跟着本指南学习，你并不需要这么做。但是，建议你在虚拟机上跑一个测试用的实例，在测试的实例上跑本书中的例子，以免稍有不慎把你自己的系统搅得一团糟。

## 1.7 开始动手之前

敲代码之前，我们先来学习一些基本知识。每个人的系统和调校习惯都不一样，所以编译跑通你的第一个“Hello World”程序有时也会出岔子。放松心情，只要你克服了开头的阻碍，后面的路途一马平川。

1. 模块版本（modversioning）问题。为一个版本的内核编译的模块，到了另一个内核上没法加载，除非编译内核时开启了`CONFIG_MODVERSIONS`选项。我们直到本书后面才会讲到模块版本问题。在开启了该选项的内核上，本书前面的例子可能没法正常跑通，然而多数流行发行版的内核都开启了这个选项。如果你因为版本错误的问题跑不通本书的例子，请将模块版本选项关掉，重新编译内核。
2. 使用桌面环境（X Window）。极其建议你在命令行终端上解压、编译和加载本书中涉及的模块，最好不要在桌面环境整。模块不像`printf`函数，没法向屏幕输出内容；不过模块可以以日志形式记录相关信息和警告，你可以通过终端开来看。如果你在xterm等图形化模拟终端用`insmod`命令加载模块，相关信息和警告是会被记录，但只会直接输出到你的systemd日志里，这样一来你只能用`journalctl`命令看到，具体细节参考[4]()。为了即时获取相关信息，请直接在字符终端上操作。
3. 安全启动（Secure Boot）。当代很多电脑出厂预设开启了UEFI安全启动特性。安全启动是一个安全标准，确保设备只能从原厂商信任的软件引导启动。一些Linux发行版的内核支持安全启动，这些发行版上，内核模块都得用密钥进行签名，否则你在跑第一个helloworld模块时就会报错`ERROR: could not insert module`。

    ```shell
    insmod ./hello-1.ko
    ```
    
    之后你用`dmesg`命令深入探究，会看到`Lockdown: insmod: unsigned module loading is restricted; see man kernel lockdown.7`

    如果你看到了这条信息，最简单的方法就是在BIOS里关闭安全启动，然后再试试加载模块。你也可以通过一通复杂的操作生成密钥，然后把密钥安装到你的系统上，再然后用密钥签名模块，最后再加载模块跑起来。然而这个操作对新手来说不太适合。如果你感兴趣的话可以参考[安全启动]()中的步骤。
